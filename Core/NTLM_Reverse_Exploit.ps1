<#
.SYNOPSIS
    NTLM 反向滲透模組 - DLL 佔位符反制系統

.DESCRIPTION
    將真實 NTLM DLL 重命名為 *_system.dll
    創建假的 DLL 佔位符，當攻擊者調用時觸發反制
    
.NOTES
    作者：Manus AI
    版本：1.0
#>

#Requires -RunAsAdministrator

param(
    [switch]$Enable,
    [switch]$Disable
)

$NTLMDLLs = @(
    "$env:SystemRoot\System32\msv1_0.dll",
    "$env:SystemRoot\System32\ntlmshared.dll"
)

function Enable-Placeholder {
    foreach ($dll in $NTLMDLLs) {
        if (Test-Path $dll) {
            # 重命名真實 DLL
            $systemDLL = $dll -replace '\.dll$', '_system.dll'
            Move-Item $dll $systemDLL -Force
            
            # 創建佔位符（反制腳本）
            @"
// NTLM 反制佔位符
// 當攻擊者調用此 DLL 時，觸發反制系統
#include <windows.h>

BOOL APIENTRY DllMain(HMODULE hModule, DWORD reason, LPVOID lpReserved) {
    if (reason == DLL_PROCESS_ATTACH) {
        // 記錄攻擊者資訊
        system("powershell -c \"Get-NetTCPConnection | Out-File C:\\attack_log.txt\"");
        
        // 調用真實系統 DLL
        LoadLibrary("$systemDLL");
    }
    return TRUE;
}
"@ | Set-Content $dll -Encoding ASCII
            
            Write-Host "[+] 已創建佔位符: $dll" -ForegroundColor Green
        }
    }
}

function Disable-Placeholder {
    foreach ($dll in $NTLMDLLs) {
        $systemDLL = $dll -replace '\.dll$', '_system.dll'
        if (Test-Path $systemDLL) {
            Remove-Item $dll -Force -ErrorAction SilentlyContinue
            Move-Item $systemDLL $dll -Force
            Write-Host "[+] 已恢復: $dll" -ForegroundColor Green
        }
    }
}

if ($Enable) { Enable-Placeholder }
elseif ($Disable) { Disable-Placeholder }
else {
    Write-Host @"
使用方法:
  啟用: .\NTLM_Reverse_Exploit.ps1 -Enable
  禁用: .\NTLM_Reverse_Exploit.ps1 -Disable
"@
}
